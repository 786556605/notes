<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="https://notes.shichao.io/tcpv1/ch7/">
        <link rel="shortcut icon" href="../../toki_32.png">
        

	<title>Chapter 7. Firewalls and Network Address Translation (NAT) - Shichao's Notes</title>

        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">
        <link href="../../css/base.css" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,400italic,500,600" rel="stylesheet">
        <link href="../../custom.css" rel="stylesheet">
        <link href="../../github.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            <a class="navbar-brand" href="../..">Shichao's Notes</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            
            
                <li >
                    <a href="../..">Home</a>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">APUE <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../../apue/ch1/">Chapter 1. UNIX System Overview</a>
                        </li>
                    
                        <li >
                            <a href="../../apue/ch2/">Chapter 2. UNIX Standardization and Implementations</a>
                        </li>
                    
                        <li >
                            <a href="../../apue/ch3/">Chapter 3. File I/O</a>
                        </li>
                    
                        <li >
                            <a href="../../apue/ch4/">Chapter 4. Files and Directories</a>
                        </li>
                    
                        <li >
                            <a href="../../apue/ch5/">Chapter 5. Standard I/O Library</a>
                        </li>
                    
                        <li >
                            <a href="../../apue/ch6/">Chapter 6. System Data Files and Information</a>
                        </li>
                    
                        <li >
                            <a href="../../apue/ch7/">Chapter 7. Process Environment</a>
                        </li>
                    
                        <li >
                            <a href="../../apue/ch8/">Chapter 8. Process Control</a>
                        </li>
                    
                        <li >
                            <a href="../../apue/ch9/">Chapter 9. Process Relationships</a>
                        </li>
                    
                        <li >
                            <a href="../../apue/ch10/">Chapter 10. Signals</a>
                        </li>
                    
                        <li >
                            <a href="../../apue/ch11/">Chapter 11. Threads</a>
                        </li>
                    
                        <li >
                            <a href="../../apue/ch12/">Chapter 12. Thread Control</a>
                        </li>
                    
                        <li >
                            <a href="../../apue/ch13/">Chapter 13. Daemon Processes</a>
                        </li>
                    
                        <li >
                            <a href="../../apue/ch14/">Chapter 14. Advanced I/O</a>
                        </li>
                    
                        <li >
                            <a href="../../apue/ch15/">Chapter 15. Interprocess Communication</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">LKD <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../../lkd/ch1/">Chapter 1. Introduction to the Linux Kernel</a>
                        </li>
                    
                        <li >
                            <a href="../../lkd/ch2/">Chapter 2. Getting Started with the Kernel</a>
                        </li>
                    
                        <li >
                            <a href="../../lkd/ch3/">Chapter 3. Process Management</a>
                        </li>
                    
                        <li >
                            <a href="../../lkd/ch4/">Chapter 4. Process Scheduling</a>
                        </li>
                    
                        <li >
                            <a href="../../lkd/ch5/">Chapter 5. System Calls</a>
                        </li>
                    
                        <li >
                            <a href="../../lkd/ch6/">Chapter 6. Kernel Data Structures</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">UNP <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../../unp/ch1/">Chapter 1. Introduction</a>
                        </li>
                    
                        <li >
                            <a href="../../unp/ch2/">Chapter 2. The Transport Layer: TCP, UDP, and SCTP</a>
                        </li>
                    
                        <li >
                            <a href="../../unp/ch3/">Chapter 3. Sockets Introduction</a>
                        </li>
                    
                        <li >
                            <a href="../../unp/ch4/">Chapter 4. Elementary TCP Sockets</a>
                        </li>
                    
                        <li >
                            <a href="../../unp/ch5/">Chapter 5. TCP Client/Server Example</a>
                        </li>
                    
                        <li >
                            <a href="../../unp/ch6/">Chapter 6. I/O Multiplexing: The select and poll Functions</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li class="dropdown active">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">TCPv1 <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../ch1/">Chapter 1. Introduction</a>
                        </li>
                    
                        <li >
                            <a href="../ch2/">Chapter 2. The Internet Address Architecture</a>
                        </li>
                    
                        <li >
                            <a href="../ch5/">Chapter 5. The Internet Protocol (IP)</a>
                        </li>
                    
                        <li class="active">
                            <a href="./">Chapter 7. Firewalls and Network Address Translation (NAT)</a>
                        </li>
                    
                        <li >
                            <a href="../ch10/">Chapter 10. User Datagram Protocol (UDP) and IP Fragmentation</a>
                        </li>
                    
                        <li >
                            <a href="../headers/">Headers</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">UTLK <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../../utlk/ch1/">Chapter 1. Introduction</a>
                        </li>
                    
                        <li >
                            <a href="../../utlk/ch2/">Chapter 2. Memory Addressing</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">ICND <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../../icnd1/part1/">ICND1 Part I: Networking Fundamentals</a>
                        </li>
                    
                        <li >
                            <a href="../../icnd2/part1/">ICND2 Part I: LAN Switching</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">Others <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../../htae/">HTAE</a>
                        </li>
                    
                        <li >
                            <a href="../../golang/">Go</a>
                        </li>
                    
                        <li >
                            <a href="../../bash/">Bash</a>
                        </li>
                    
                        <li >
                            <a href="../../c/">C</a>
                        </li>
                    
                        <li >
                            <a href="../../asm/">x86 assembly</a>
                        </li>
                    
                        <li >
                            <a href="../../iptables/">iptables</a>
                        </li>
                    
                        <li >
                            <a href="../../nginx/">Nginx</a>
                        </li>
                    
                        <li >
                            <a href="../../vim/">Vim</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            </ul>
            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                
                <li>
                    
                        <a href="https://github.com/shichao-an/notes/blob/master/docs/tcpv1/ch7.md">
                    
                        
                            <i class="fa fa-github"></i>
                        
                        GitHub
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#chapter-7-firewalls-and-network-address-translation-nat">Chapter 7. Firewalls and Network Address Translation (NAT)</a></li>
        
    
        <li class="main "><a href="#firewalls">Firewalls</a></li>
        
            <li><a href="#packet-filtering-firewalls">Packet-Filtering Firewalls</a></li>
        
            <li><a href="#proxy-firewalls">Proxy Firewalls</a></li>
        
    
        <li class="main "><a href="#network-address-translation-nat">Network Address Translation (NAT)</a></li>
        
            <li><a href="#traditional-nat-basic-nat-and-napt">Traditional NAT: Basic NAT and NAPT</a></li>
        
    
    </ul>
</div></div>
            <div class="col-md-9" role="main">
              

<h3 id="chapter-7-firewalls-and-network-address-translation-nat"><strong>Chapter 7. Firewalls and Network Address Translation (NAT)</strong></h3>
<blockquote>
<p>Perhaps ironically, the development and eventual widespread use of NAT has contributed to significantly slow the adoption of IPv6.
<small><em>TCPv1</em></small></p>
</blockquote>
<p>Many security problems (attacks) were caused by bugs or unplanned protocol operations in the software implementations of Internet hosts. Fixing the problem would have required a way to control the Internet traffic to which the end hosts were exposed. Today, this is provided by a <strong>firewall</strong>, a type of router that restricts the types of traffic it forwards. [p299]</p>
<p>As firewalls are being deployed, another problem was becoming important: the number of available IPv4 addresses was diminishing,
with a threat of exhaustion. One of the most important mechanisms developed to deal with this, aside from IPv6, is called <strong>Network Address Translation</strong> (NAT). With NAT, Internet addresses need not be globally unique, but can be reused in different parts of the Internet, called <em>address realms</em>. This greatly eased the problem of address exhaustion.</p>
<h3 id="firewalls">Firewalls</h3>
<p>Given the enormous management problems associated with trying to keep end system software up-to-date and bug-free, the focus of resisting attacks expanded</p>
<ul>
<li>From: securing end systems,</li>
<li>To: restricting the Internet traffic allowed to flow to end systems by filtering out some traffic using firewalls.</li>
</ul>
<p>Today, several different types of firewalls have evolved.</p>
<p>The two major types of firewalls commonly used include <strong>proxy firewalls</strong> and <strong>packet-filtering firewalls</strong>. The main difference between them is the layer in the protocol stack at which they operate, and consequently the way IP addresses and port numbers are used. The packet-filtering firewall is an Internet router that drops datagrams that (fail to) meet specific criteria. The proxy firewall operates as a multihomed server host from the viewpoint of an Internet client. That is, it is the endpoint of TCP and UDP transport associations; it does not typically route IP datagrams at the IP protocol layer.</p>
<h4 id="packet-filtering-firewalls">Packet-Filtering Firewalls</h4>
<p>Packet-filtering firewalls act as Internet routers and filter (drop) some traffic. They can generally be configured to discard or forward packets whose headers meet (or fail to meet) certain criteria, called <em>filters</em>.</p>
<p>Popular filters involve:</p>
<ul>
<li>Undesired IP addresses or options,</li>
<li>Types of ICMP messages,</li>
<li>Various UDP or TCP services, based on the port numbers contained in each packet.</li>
</ul>
<p>Stateless and stateful:</p>
<ul>
<li><em>Stateless</em> firewalls treat each datagram individually.</li>
<li><em>Stateful</em> firewalls are able associate packets with either previous or future packets to make inferences about datagrams or streams.</li>
</ul>
<p>[p300]</p>
<p>A typical packet-filtering firewall is shown below.</p>
<p>In this figure</p>
<ul>
<li>The firewall is an Internet router with three network interfaces:<ul>
<li>"inside"</li>
<li>"outside"</li>
<li>"DMZ"</li>
</ul>
</li>
<li>The DMZ subnet provides access to an extranet or DMZ where servers are deployed for Internet users to access.</li>
<li>Network administrators install filters or <strong>access control lists</strong> (ACLs, basically policy lists indicating what types of packets to discard or forward) in the firewall.</li>
<li>Typically, these filters conservatively block traffic from the outside that may be harmful and liberally allow traffic to travel from inside to outside.</li>
</ul>
<p><a href="../figure_7-1.png" title="A typical packet-filtering firewall configuration. The firewall acts as an IP router between an “inside” and an “outside” network, and sometimes a third “DMZ” or extranet network, allowing only certain traffic to pass through it. A common configuration allows all traffic to pass from inside to outside but only a small subset of traffic to pass in the reverse direction. When a DMZ is used, only certain services are permitted to be accessed from the Internet."><img alt="A typical packet-filtering firewall configuration. The firewall acts as an IP router between an “inside” and an “outside” network, and sometimes a third “DMZ” or extranet network, allowing only certain traffic to pass through it. A common configuration allows all traffic to pass from inside to outside but only a small subset of traffic to pass in the reverse direction. When a DMZ is used, only certain services are permitted to be accessed from the Internet." src="../figure_7-1.png" /></a></p>
<h4 id="proxy-firewalls">Proxy Firewalls</h4>
<p>Proxy firewalls are not really Internet routers. They are essentially hosts running one or more <a href="https://en.wikipedia.org/wiki/Application-level_gateway"><strong>application-layer gateways</strong></a> (ALGs), hosts with more than one network interface that relay traffic of certain types between one connection/association and another at the application layer.</p>
<p>The figure below illustrates a proxy firewall:</p>
<ul>
<li>Clients on the inside of the firewall are usually configured in a special way to associate (or connect) with the proxy instead of the actual end host providing the desired service.</li>
<li>The firewalls act as multihomed hosts with their IP forwarding capability typically disabled.</li>
<li>As with packet-filtering firewalls, a common configuration is to have an "outside" interface assigned a globally routable IP address and for its "inner" interface to be configured with a private IP address. Thus, proxy firewalls support the use of private address realms.</li>
</ul>
<p><a href="../figure_7-2.png" title="The proxy firewall acts as a multihomed Internet host, terminating TCP connections and UDP associations at the application layer. It does not act as a conventional IP router but rather as an ALG. Individual applications or proxies for each service supported must be enabled for communication to take place through the proxy firewall."><img alt="The proxy firewall acts as a multihomed Internet host, terminating TCP connections and UDP associations at the application layer. It does not act as a conventional IP router but rather as an ALG. Individual applications or proxies for each service supported must be enabled for communication to take place through the proxy firewall." src="../figure_7-2_600.png" /></a></p>
<p>This type of firewall can be quite secure at the cost of brittleness and lack of flexibility:</p>
<ul>
<li>Since this style of firewall must contain a proxy for each transport-layer service, any new services to be used must have a corresponding proxy installed and operated for connectivity to take place through the proxy.</li>
<li>Each client must be configured to find the proxy, for example using the <a href="https://en.wikipedia.org/wiki/Web_Proxy_Autodiscovery_Protocol">Web Proxy Auto-Discovery Protocol</a> (WPAD), although there are some alternatives: capturing proxies that catch all traffic of a certain type regardless of destination address).</li>
<li>Significant intervention is required from network operators to support additional services.</li>
</ul>
<p>The two most common forms of proxy firewalls are HTTP proxy firewalls and SOCKS firewalls.</p>
<ul>
<li><strong>HTTP proxy firewalls</strong>, also called <strong>Web proxies</strong>, work only for the HTTP and HTTPS (Web) protocols.<ul>
<li>These proxies act as Web servers for internal clients and as Web clients when accessing external Web sites.</li>
<li>Such proxies often also operate as <strong>Web caches</strong>. These caches save copies of Web pages so that subsequent accesses can be served directly from the cache instead of from the originating Internet Web server. Doing so can reduce latency to display Web pages and improve the experience of users accessing the Web.</li>
<li>Some Web proxies are also used as <strong>content filters</strong>, which attempt to block access to certain Web sites based on a “blacklist” of prohibited sites. Conversely, <strong>tunneling proxy servers</strong> are available on the Internet. These servers (e.g., <a href="https://en.wikipedia.org/wiki/Psiphon">psiphon</a>, <a href="https://en.wikipedia.org/wiki/CGIProxy">CGIProxy</a>) essentially perform the opposite function: to allow users to avoid being blocked by content filters.</li>
</ul>
</li>
<li><strong>SOCKS firewalls</strong> uses the <a href="https://en.wikipedia.org/wiki/SOCKS">SOCKS protocol</a>, which is more generic than HTTP for proxy access and is applicable to more services than just the Web. Two versions of SOCKS are currently in use: version 4 (SOCKS5) and version 5 (SOCKS5). Version 4 provides the basic support for proxy traversal, and version 5 adds strong authentication, UDP traversal, and IPv6 addressing.<ul>
<li>To use a SOCKS proxy, an application must be written to use SOCKS (it must be "socksified") and configured to know the location and version of the SOCKS proxy. Then the client uses the SOCKS protocol to request the proxy to perform network connections and, optionally, DNS lookups.</li>
</ul>
</li>
</ul>
<h3 id="network-address-translation-nat">Network Address Translation (NAT)</h3>
<p>NAT is a mechanism that allows the same sets of IP addresses to be reused in different parts of the Internet. With NAT as a common use, all incoming and outgoing traffic passes through a single NAT device that partitions the inside (private) address realm from the global Internet address realm, all the internal systems can be provided Internet connectivity as clients using locally assigned, private IP addresses. [p303]</p>
<p>NAT was introduced to solve two problems: address depletion and concerns regarding the scalability of routing. NAT was initially suggested as a stopgap, temporary measure to be used until the deployment of some protocol with a larger number of addresses (IPv6) became widespread. Routing scalability was being tackled with the development of Classless Inter-Domain Routing (CIDR, <a href="../ch2/">Chapter 2</a>)</p>
<p>NAT is popular because:</p>
<ol>
<li>It reduces the need for globally routable Internet addresses</li>
<li>It offers some degree of natural firewall capability and requires little configuration.</li>
</ol>
<p>Perhaps ironically, the development and eventual widespread use of NAT has contributed to significantly slow the adoption of IPv6. Among its other benefits, IPv6 was intended to make NAT unnecessary.</p>
<p>NAT has several drawbacks:</p>
<ul>
<li>Offering Internet-accessible services from the private side requires special configuration because privately addressed systems are not directly reachable from the Internet.</li>
<li>Every packet in both directions of a connection or association must pass through the same NAT, because the NAT must actively rewrite the addressing information in each packet.<ul>
<li>NATs require connection state on a <em>per-association</em> (or <em>per-connection</em>) basis and must operate across multiple protocol layers, unlike conventional routers. Modifying an address at the IP layer also requires modifying checksums at the transport layer (see <a href="../ch10/">Chapters 10</a> and <a href="ch13.md">Chatper 13</a> regarding the pseudoheader checksum)</li>
</ul>
</li>
<li>Some applications protocols, especially those that send IP addressing information inside the application-layer payload, such as <a href="https://en.wikipedia.org/wiki/File_Transfer_Protocol">File Transfer Protocol</a> (FTP) and <a href="https://en.wikipedia.org/wiki/Session_Initiation_Protocol">Session Initiation Protocol</a> (SIP), require a special application-layer gateway function that rewrites the application content in order to work unmodified with NAT or other NAT traversal methods that allow the applications to determine how to work with the specific NAT they are using.</li>
</ul>
<p>Despite its shortcomings, NATs are very widely used, and most network routers support it; NAT supports the basic protocols (e.g., e-mail, Web browsing) that are needed by millions of client systems accessing the Internet every day.</p>
<p>A NAT works by rewriting the identifying information in packets transiting through a router. Most commonly NAT involves rewriting the source IP address of packets as they are forwarded in one direction and the destination IP addresses of packets traveling in the reverse direction. This allows the source IP address in outgoing packets to become one of the NAT router’s Internet-facing interfaces instead of the originating host’s. Thus, <u>to a host on the Internet, packets coming from any of the hosts on the privately addressed side of the NAT appear to be coming from a globally routable IP address of the NAT router.</u></p>
<p>Most NATs perform both <em>translation</em> and <em>packet filtering</em>, and the packet-filtering criteria depend on the dynamics of the NAT state. The choice of packet-filtering policy may have a different granularity. For example, the treatment of unsolicited packets (those not associated with packets originating from behind the NAT) received by the NAT may depend on source and destination IP address and/or source and destination port number. [p305]</p>
<h4 id="traditional-nat-basic-nat-and-napt">Traditional NAT: Basic NAT and NAPT</h4>
            </div>
        </div>

        <footer class="col-md-12">
            
        </footer>

        <script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script>
        <script src="../../js/base.js"></script>
        <script src="../../custom.js"></script>
    </body>
</html>